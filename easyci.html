<div id="navCategory"><p style="font-size:18px"></p><h1>阅读目录</h1><p></p><ul><li><a href="#_label0" style="font-size:16px">前言</a></li><li><a href="#_label1" style="font-size:16px">系统架构</a><ul><li><a href="#_label1_0">Jenkins系统架构</a></li><li><a href="#_label1_1">EasyCi系统架构</a></li></ul></li></ul></div>
<h1>前言</h1>
<p>　　本人是一家互联网公司的java开发，由于公司初期公司未招运维人员，恰好我对linux比较熟悉，便在公司服务器搭建了一套Jenkins、Gitlab、Maven私服、Docker私服、Sonarqube、ELK、FastDFS等一套持续集成的运维环境。</p>
<p>　　后来发现，运维这块以后也归我管了&hellip;&hellip;平时做系统开发，还要兼职运维，一些前端或者后端的发布都要找我来创建Jenkins 项目、添加gitlab hook、添加dockerfile文件等等。</p>
<p>　　所以就想自己写一套简单的持续化集成发布的系统。便有了接下来的EasyCi。</p>
<p>　　EasyCi系统开发的目的是免去远程发布的免密登陆、拉取gitlab代码的认证、手动添加gitlab hook、查看gitlab中该项目的git地址等等多余的操作。这些操作均有后台自动完成，系统提供运行环境一键安装脚本、自动化安装部署本系统、开箱即用，只需要几个参数即可实现项目的远程构建，暂时只支持vue和java项目的构建。</p>
<p>　　Easyci系统采用B/S架构，后端采用springboot框架、前端采用Vue的element ui、数据库采用mysql、运行工具为shell脚本、采用websocket进行实时日志传输。</p>
<p>　　由于系统由本人独立开发，对前端开发不是很擅长，页面比较简单，只为实现基本功能，后续会对功能和页面进行优化。</p>
<h1>系统架构</h1>
<h2>Jenkins系统架构</h2>
<h3>工具链</h3>
<p>Jenkins：集成各种工具，持续集成、持续交付</p>
<p>Gitlab：代码托管库，通过gitlab hook触发Jenkins持续集成交付</p>
<p>Maven私服：私有jar包仓库</p>
<p>Docker私服：私有docker镜像仓库，用于远程构建</p>
<p>Sonarqube：代码审查工具</p>
<p>ELK：日志手机系统、分析系统</p>
<h3>流程</h3>
<p>1.Jenkins集成gitlab、maven、docker、sonarqube，安装各种插件</p>
<p>2.开发人员提交代码到gitlab，触发gitlab hook中添加的jenkins项目url进行jenkins构建</p>
<p>3.jenkins自动拉取该项目的gitlab代码，进行打包、再打包成docker镜像，docker镜像提交到docker私服</p>
<p>4.连接需要发布的服务器，拉去docker私服中该项目的镜像，docker run运行容器&nbsp;</p>
<p>5.Jenkins构建项目运行完成后添加gitlab tag并提交gitlab作为以后回滚的依据</p>
<p>6.Jenkins构建失败则自动拉取最新的gitlab tag重新构建，执行回滚，回滚再次构建失败便停止</p>
<p>7.构建成功或者回滚成功或者回滚失败都会通过linux的sendmail发送邮件提醒，并附加构建日志</p>
<p>8.构建的代码会通过sonarqube插件上传sonarqube进行代码审查</p>
<h3>系统图</h3>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132019967-777345403.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132030118-288340431.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132040806-478864170.png" alt="" /></p>
<p>&nbsp;<img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132049710-1886899823.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132058394-1959234511.png" alt="" /></p>
<p>&nbsp;<img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132108575-370018543.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132117572-383542775.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132127422-403393614.png" alt="" /></p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019132134240-1992221563.png" alt="" /></p>
<h2>EasyCi系统架构</h2>
<h3>工具链</h3>
<p>EasyCI：easyci系统后台，调用shell脚本、通过接口将结果返回前端</p>
<p>EasyCI-UI：easyci系统前台，vue。调用后台接口展示数据</p>
<p>Gitlab：代码托管工具，通过gitlab hook触发easyci持续集成交付</p>
<p>shell脚本：linux脚本</p>
<p>Docker私服：私有docker镜像仓库，用于远程构建</p>
<p>MySQL：easyci系统数据库</p>
<h3>流程</h3>
<p>1.根据安装文档安装系统，启动系统</p>
<p>2.访问系统首先需要验证gitlab：gitlab的url、用户名和密码。用于选择项目构建、服务器拉取代码验证、自动添加hook，免去手动操作。</p>
<p>3.添加远程发布服务器：服务器ip、端口、用户名、密码。后台自动完成服务器间的免密登录，用于项目远程发布、查看服务器容器以及容器的各种操作。</p>
<p>4.部署：选择项目url、输入docker容器端口映射关系、选择项目类型、输入收件人邮箱、选择部署服务器，只需要输入两项内容即可完成部署。</p>
<p>5.点击部署，会弹出窗口显示系统部署日志。</p>
<p>6.部署会自动添加easyci的hook接口url到该部署项目的hook中，用于自动触发构建。</p>
<p>7.部署完成自动发送邮件给收件人邮箱，显示构建结果、构建时间、构建项目、构建日志。</p>
<p>8.后续开发人员提交代码到该项目的gitlab，会触发gitlab的hook调用easyci接口，查询之前部署的信息进行自动部署，实现持续集成。</p>
<p>9.页面展示easyci本机正在运行的容器和添加的远程服务器正在运行的容器，支持数据自动刷新与关闭</p>
<p>10.可以选择添加的远程服务器，查看该服务器的容器列表</p>
<p>11.容器操作：可点击启动&nbsp; 、停止、重启、销毁在页面对服务器中运行的容器进行操作，即docker&nbsp; start|stop|restart|rm 容器名称</p>
<p>12..容器实时日志：点击日志，可以查看该容器的实时日志，即docker logs -f 容器名称</p>
<h3>安装教程</h3>
<p>1.系统准备</p>
<ul>
<li>本系统仅支持Centos7系统</li>
<li>配置2H4G</li>
<li>固定好ip</li>
</ul>
<p>1.在公司服务器中分出一个虚拟机作为easyci的运行环境，要求如上图所示。</p>
<p><span style="color: #ff0000;">注意:该虚拟机最好不要运行其他服务，因为easyci会先在本地运行容器测试部署结果，再发送到远程服务器运行容器，要注意端口占用。</span></p>
<p>2.将easyici.zip通过winscp或者xftp等。</p>
<p>这里我放到/root目录下。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019133317074-643526343.png" alt="" /></p>
<p>&nbsp;3.通过xshell或者其他工具连接服务器。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019133542736-1890083958.png" alt="" /></p>
<p>&nbsp;4.进入/root目录，将easyci.zip解压</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019133835312-414064219.png" alt="" /></p>
<p>&nbsp;如果解压unzip没有命令，可以执行 <span style="color: #ff0000;">yum install -y unzip</span> 安装</p>
<p>再次解压。解压后生成easyci文件夹。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019134005278-117768227.png" alt="" /></p>
<p>&nbsp;5.进入easyci文件夹</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019134605587-410830640.png" alt="" /></p>
<p>&nbsp;6.编辑install.sh，修改第35行中的<span style="color: #ff0000;">localhost修改为本机ip</span></p>
<ul>
<li>vi install</li>
</ul>
<p>按住&ldquo;ℹ️&rdquo;进入编辑，修改localhost为本机ip</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019134819022-258243124.png" alt="" /></p>
<p>&nbsp;修改完成后，按&ldquo;Esc&rdquo;退出编辑状态，按&ldquo;：&rdquo;输入wq回车，保存。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019135043627-1850023778.png" alt="" /></p>
<p>&nbsp;该install脚本为easyci系统部署所需要所有工具的安装，可按需调整。</p>
<p>7.运行install脚本，进行系统安装</p>
<ul>
<li>bash install.sh</li>
</ul>
<p>系统安装会持续20分钟左右，具体看网速。</p>
<p>出现下图，表示系统所需工具初步安装完成。</p>
<p>&nbsp;<img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019140235069-1501413794.png" alt="" /></p>
<p>&nbsp;8.重载/etc/profile配置文件。</p>
<ul>
<li>source /etc/profile</li>
</ul>
<p>测试java、maven、node等命令是否正常安装。</p>
<ul>
<li>java -version</li>
<li>mvn -v</li>
<li>node -v</li>
<li>npm -v</li>
</ul>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019140552962-331563181.png" alt="" /></p>
<p>&nbsp;ok,工具按住完成。</p>
<p>9.永久关闭selinux</p>
<ul>
<li>vi /etc/selinux/config</li>
</ul>
<p><span style="color: #ff0000;">将SELINUX=enforcing改为SELINUX=disabled</span><br />设置后需要<span style="color: #ff0000;">重启</span>才能生效。</p>
<p>10.开放mysql的root用户远程访问。</p>
<ul>
<li>mysql -hlocalhost -uroot -p123456</li>
<li>grant all privileges on *.* to root@"%" identified by ".";</li>
<li>flush privileges;</li>
<li>exit</li>




</ul>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019141004680-54238132.png" alt="" /></p>
<p>&nbsp;11.启动系统</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019141233405-2104006116.png" alt="" /></p>
<p>&nbsp;进入easyci系统家目录/home/easyici</p>
<p>执行<span style="color: #ff0000;">./startEasyCi.sh</span>启动系统</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019141512754-874670282.png" alt="" /></p>
<ul>
<li>&nbsp;netstat -tunlp | grep -E "9875|81"</li>




</ul>
<p>查看前端81端口和后端9875端口是否开启成功。</p>
<h3>使用教程</h3>
<p>1.访问系统&nbsp; 浏览器打开 ip:81</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019141858603-1363781745.png" alt="" width="1193" height="538" /></p>
<p>&nbsp;系统启动首先需要验证gitlab。</p>
<p><span style="color: #000000;">gitlaburl：<span style="color: #ff0000;">输入gitlab的地址，不要加http：</span></span></p>
<p><span style="color: #000000;">用户名密码：建议用户名和密码输入管理员root的用户名和密码。</span></p>
<p><span style="color: #ff0000;">注：这里的密码不要包含@ / 等特殊符号，否则免认证拉取git代码会失败</span></p>
<p><span style="color: #000000;">此处输入点击登录，后台会调用gitlab api拿到access-token，用于在服务器中拉取免密拉取代码、部署时选择构建的项目。</span></p>
<p><span style="color: #000000;">2.添加远程部署服务器</span></p>
<p><span style="color: #000000;"><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019142327590-1954325836.png" alt="" width="1044" height="500" /></span></p>
<p>&nbsp;输入信息点击添加，系统会系统生成本服务器的公钥，添加到该服务器的认证文件中实现免密登陆。</p>
<p>添加完成之后会展示该服务器的docker容器列表，可以进行启动、停止、重启、销毁、查看实时日志操作。</p>
<p>&nbsp;添加服务器完成，会显示本机的容器列表和添加服务器的容器列表。<img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019142823785-1688156752.png" alt="" width="1394" height="708" /></p>
<p>如果有多个远程服务器，可以选择某个服务器，查看该服务器的容器列表，也可以开启自动刷新，实时刷新容器数据。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019143111837-1987456998.png" alt="" /></p>
<p>&nbsp;&ldquo;启动｜停止｜重启｜销毁&rdquo;等操作同步docker start｜stop｜restart｜rm 容器名称。</p>
<p>&ldquo;日志&rdquo;可以查看该服务器的实时日志，即docker logs -f -tail 200 容器名称。查看该容器近200行日志，并实时刷新。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019143958614-1822728381.png" alt="" /></p>
<p>&nbsp;3.项目构建</p>
<p>点击选择需要部署的gitlab醒目</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019144156493-106618067.png" alt="" width="890" height="151" /></p>
<p>&nbsp;端口输入端口映射对。</p>
<p>由于是采用docker容器运行。需要设置映射端口</p>
<p>例如6000:5000</p>
<p>前面的6000为宿主机对外访问开放的端口，后面的5000为构建项目的端口，<span style="color: #ff0000;">注意&ldquo;：&rdquo;为英文状态下</span></p>
<p>项目语言选择vue或者java。</p>
<p>收件人邮箱：如果有多个以&ldquo;，&rdquo;分割</p>
<p>部署方式：选择要部署的服务器。</p>
<p><span style="color: #ff0000;">注意：本系统是在本地先运行测试容器是否正常运行。运行正常则本地会删除容器释放端口，再发布到远程服务器运行。</span></p>
<p><span style="color: #ff0000;">所以注意本地端口占用。系统初始端口如下：</span></p>
<p><span style="color: #ff0000;">22、25、81、5000、3306、9875、68、323</span></p>
<p><span style="color: #ff0000;">即端口映射前面的端口不能为上述端口。</span></p>
<p><span style="color: #ff0000;"><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019151941429-1631096403.png" alt="" /></span></p>
<p>&nbsp;如果本地或者远程端口被占用，会停止构建，弹窗提醒。</p>
<p>这里easyci本地运行的docker私服占用了5000端口，再发布5000端口的宿主映射会提示&ldquo;端口已被占用&rdquo;</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019153142125-567725812.png" alt="" /></p>
<p>&nbsp;换其他端口，开始部署，显示部署日志</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019155208164-1529664877.png" alt="" /></p>
<p>&nbsp;容器部署成功会有邮件提醒。</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019155401775-981770532.png" alt="" /></p>
<p>&nbsp;部署日志</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201910/1335688-20191019155501841-205511117.png" alt="" /></p>
