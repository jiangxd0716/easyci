<h1>前言</h1>
<p>　　SonarQube 是一款用于代码质量管理的开源工具，它主要用于管理源代码的质量。 通过插件形式，可以支持众多计算机语言，比如 java, C#, go，C/C++, PL/SQL, Cobol, JavaScrip, Groovy 等。sonar可以通过PMD,CheckStyle,Findbugs等等代码规则检测工具来检测你的代码，帮助你发现代码的漏洞，Bug，异味等信息。 Sonar 不仅提供了对 IDE 的支持，可以在 Eclipse和 IntelliJ IDEA 这些工具里联机查看结果；同时 Sonar 还对大量的持续集成工具提供了接口支持，可以很方便地在持续集成中使用 Sonar。&nbsp;</p>
<p><span style="color: #ff0000;">sonarqube7.9的前提条件是jdk11、postgreSQL</span></p>
<p>链接：https://pan.baidu.com/s/1BcrQhzv3piH7CBRPfB_RTg 提取码：6d1q</p>
<h1>安装</h1>
<h2>jdk11安装</h2>
<p>参考：<a href="https://www.cnblogs.com/jxd283465/p/11541506.html">https://www.cnblogs.com/jxd283465/p/11541506.html</a></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">[root@localhost home]# java -version
</span><span style="color: #008080;">2</span> <span style="color: #000000;">java version "11.0.4" 2019-07-16 LTS
</span><span style="color: #008080;">3</span> <span style="color: #000000;">Java(TM) SE Runtime Environment 18.9 (build 11.0.4+10-LTS)
</span><span style="color: #008080;">4</span> Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.4+10-LTS, mixed mode)</pre>
</div>
<h2>postgreSQL10.1安装</h2>
<p>参考：<a href="https://www.cnblogs.com/jxd283465/p/11550745.html">https://www.cnblogs.com/jxd283465/p/11550745.html</a></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">[root@localhost bin]# ./psql -V
</span><span style="color: #008080;">2</span> psql (PostgreSQL) 10.10</pre>
</div>
<h2>sonarqube7.9安装</h2>
<p>1.解压，重命名</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;"># 解压
unzip sonarqube-7.9.1.zip 

# 重命名
mv sonarqube-7.9.1 sonarqube</span></pre>
</div>
<p>如果报错unzip not command： yum -y install unzip</p>
<p>2.创建sonarqube用户组和用户、赋权</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;"># 创建sonarqube用户组
</span><span style="color: #008080;">2</span> <span style="color: #000000;">[root@localhost home]# groupadd sonarqube
</span><span style="color: #008080;">3</span> 
<span style="color: #008080;">4</span> <span style="color: #000000;"># 创建sonarqube用户 -g指定用户组  -p指定密码  -M不创建home目录
</span><span style="color: #008080;">5</span> <span style="color: #000000;">[root@localhost home]# useradd sonarqube -g sonarqube -p sonarqube -M
</span><span style="color: #008080;">6</span> 
<span style="color: #008080;">7</span> <span style="color: #000000;"># 赋予/home/sonarqube文件夹sonarqube用户权限  -R表示递归
</span><span style="color: #008080;">8</span> [root@localhost home]# chown -R sonarqube:sonarqube /home/sonarqube</pre>
</div>
<p>3.修改配置文件</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;"># 修改sonarqube配置文件，增加postgres数据库配置
vi /home/sonarqube/conf/sonar.properties <br />
# postgres数据库用户名
sonar.jdbc.username=postgres
# postgres数据库用户名密码
sonar.jdbc.password=postgres
# postgres数据库地址
sonar.jdbc.url=jdbc:postgresql://127.0.0.1:5432/sonar?currentSchema=public
# sonar的web访问端口
sonar.web.port=9002</span></pre>
</div>
<p>4.配置启动参数</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;"># 修改sonar的启动文件
vi /home/sonarqube/bin/linux-x86-64/sonar.sh 

# 将runuser设置为sonarqube
RUN_AS_USER=sonarqube</span></pre>
</div>
<p>5.启动sonarqube</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;"># 切换sonarqube用户
</span><span style="color: #008080;">2</span> <span style="color: #000000;">[root@localhost home]# su sonarqube
</span><span style="color: #008080;">3</span> 
<span style="color: #008080;">4</span> <span style="color: #000000;"># 启动sonar
</span><span style="color: #008080;">5</span> <span style="color: #000000;">bash-4.2$ /home/sonarqube/bin/linux-x86-64/sonar.sh start
</span><span style="color: #008080;">6</span> <span style="color: #000000;">Starting SonarQube...
</span><span style="color: #008080;">7</span> Started SonarQube.</pre>
</div>
<p>浏览器访问http://192.168.8.20:9002 访问失败</p>
<p>查看日志查找原因，日志在&nbsp;/home/sonarqube/logs 下，分别查看es和sonar的启动日志</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">bash-4.2$ pwd
</span><span style="color: #008080;">2</span> <span style="color: #000000;">/home/sonarqube/logs
</span><span style="color: #008080;">3</span> <span style="color: #000000;">bash-4.2$ ls -l
</span><span style="color: #008080;">4</span> <span style="color: #000000;">总用量 12
</span><span style="color: #008080;">5</span> <span style="color: #000000;">-rw-r--r--. 1 sonarqube sonarqube 3402 9月  19 16:52 es.log
</span><span style="color: #008080;">6</span> <span style="color: #000000;">-rw-r--r--. 1 sonarqube sonarqube   88 7月  10 12:21 README.txt
</span><span style="color: #008080;">7</span> -rw-r--r--. 1 sonarqube sonarqube 1522 9月  19 16:52 sonar.log</pre>
</div>
<p>查看es.log （elasticsearch）</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">bash-4.2$ cat es.log 
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">2019.09.19 16:52:17 INFO  es[][o.e.e.NodeEnvironment] using [1] data paths, mounts [[/home (/dev/mapper/centos-home)]], net usable_space [961.2gb], net total_space [962.7gb], types [xfs]
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">2019.09.19 16:52:17 INFO  es[][o.e.e.NodeEnvironment] heap size [494.9mb], compressed ordinary object pointers [true]
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">2019.09.19 16:52:17 INFO  es[][o.e.n.Node] node name [sonarqube], node ID [k784DcanQ1e4py5e75WQYQ]
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">2019.09.19 16:52:17 INFO  es[][o.e.n.Node] version[6.8.0], pid[20791], build[default/tar/65b6179/2019-05-15T20:06:13.172855Z], OS[Linux/3.10.0-957.27.2.el7.x86_64/amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/11.0.4/11.0.4+10-LTS]
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">2019.09.19 16:52:17 INFO  es[][o.e.n.Node] JVM arguments [-XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.io.tmpdir=/home/sonarqube/temp, -XX:ErrorFile=../logs/es_hs_err_pid%p.log, -Des.enforce.bootstrap.checks=true, -Xms512m, -Xmx512m, -XX:+HeapDumpOnOutOfMemoryError, -Des.path.home=/home/sonarqube/elasticsearch, -Des.path.conf=/home/sonarqube/temp/conf/es, -Des.distribution.flavor=default, -Des.distribution.type=tar]
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [analysis-common]
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [lang-painless]
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [mapper-extras]
</span><span style="color: #008080;">10</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [parent-join]
</span><span style="color: #008080;">11</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [percolator]
</span><span style="color: #008080;">12</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [reindex]
</span><span style="color: #008080;">13</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [repository-url]
</span><span style="color: #008080;">14</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] loaded module [transport-netty4]
</span><span style="color: #008080;">15</span> <span style="color: #000000;">2019.09.19 16:52:18 INFO  es[][o.e.p.PluginsService] no plugins loaded
</span><span style="color: #008080;">16</span> <span style="color: #000000;">2019.09.19 16:52:19 WARN  es[][o.e.d.c.s.Settings] [http.enabled] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.
</span><span style="color: #008080;">17</span> <span style="color: #000000;">2019.09.19 16:52:20 INFO  es[][o.e.d.DiscoveryModule] using discovery type [zen] and host providers [settings]
</span><span style="color: #008080;">18</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.n.Node] initialized
</span><span style="color: #008080;">19</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.n.Node] starting ...
</span><span style="color: #008080;">20</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.t.TransportService] publish_address {127.0.0.1:9001}, bound_addresses {127.0.0.1:9001}
</span><span style="color: #008080;">21</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.b.BootstrapChecks] explicitly enforcing bootstrap checks
</span><span style="color: #008080;">22</span> <span style="color: #000000;">2019.09.19 16:52:21 ERROR es[][o.e.b.Bootstrap] node validation exception
</span><span style="color: #ff0000;">23 [2] bootstrap checks failed
24 [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]
25 [2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
</span><span style="color: #008080;">26</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.n.Node] stopping ...
</span><span style="color: #008080;">27</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.n.Node] stopped
</span><span style="color: #008080;">28</span> <span style="color: #000000;">2019.09.19 16:52:21 INFO  es[][o.e.n.Node] closing ...
</span><span style="color: #008080;">29</span> 2019.09.19 16:52:21 INFO  es[][o.e.n.Node] closed</pre>
</div>
<p>发现有两个错误：</p>
<pre>24 [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]
25 [2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</pre>
<p>解决第一个：</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">vi /etc/security/limits.conf
修改配置文件，在文件最后加入下面两个行。用户退出重新登录生效。
*               soft    nofile          65536
*               hard    nofile          65536</span></pre>
</div>
<p>解决第二个：</p>
<p>临时生效</p>
<div class="cnblogs_code">
<pre>sudo sysctl -w vm.max_map_count=262144</pre>
</div>
<p>永久生效</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;"># root用户
vi </span>/etc/<span style="color: #000000;">sysctl.conf 
# 添加以下配置
vm.max_map_count</span>=<span style="color: #800080;">655360</span><span style="color: #000000;">
# 生效
sysctl </span>-p</pre>
</div>
<p>重启依旧报错，查看日志发现web.log报错</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">2019.09.19 17:13:20 WARN  web[][o.a.c.l.WebappClassLoaderBase] The web application [ROOT] appears to have started a thread named [elasticsearch[_client_][transport_worker][T#12]] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.base@11.0.4/sun.nio.ch.EPoll.wait(Native Method)
 java.base@11.0.4/sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:120)
 java.base@11.0.4/sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:124)
 java.base@11.0.4/sun.nio.ch.SelectorImpl.select(SelectorImpl.java:136)
 app//io.netty.channel.nio.SelectedSelectionKeySetSelector.select(SelectedSelectionKeySetSelector.java:62)
 app//io.netty.channel.nio.NioEventLoop.select(NioEventLoop.java:765)
 app//io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:413)
 app//io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:909)
 java.base@11.0.4/java.lang.Thread.run(Thread.java:834)
2019.09.19 17:13:20 INFO  web[][o.s.s.a.EmbeddedTomcat] HTTP connector enabled on port 9002
2019.09.19 17:13:20 INFO  web[][o.s.p.ProcessEntryPoint] Hard stopping process</span></pre>
</div>
<p>经过排查是postgresql中sonar数据库未建立。</p>
<p>连接postgresql&nbsp; &nbsp;</p>
<pre>CREATE DATABASE sonar WITH OWNER=postgres ENCODING='UTF-8';</pre>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201909/1335688-20190919175439821-1623656694.png" alt="" /></p>
<p>&nbsp;启动成功。</p>
<p>初始化密码admin/admin</p>
<p>6.安装中文插件</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201909/1335688-20190919180129562-1539626395.png" alt="" /></p>
<p>&nbsp;</p>