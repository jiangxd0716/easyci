<h1><span style="font-size: 1.17em;">前言</span></h1>
<p><span style="font-size: 1.17em;">GitLab：GitLab 是一个用于仓库管理系统的开源项目，使用<a href="https://baike.baidu.com/item/Git" target="_blank">Git</a>作为代码管理工具，并在此基础上搭建起来的web服务。<br />功能：Gitlab 是一个提供代码托管、提交审核和问题跟踪的代码管理平台。对于软件工程质量管理非常重要。<br />版本：GitLab 分为社区版（CE） 和企业版（EE）。<br />配置：建议CPU2核，内存2G以上。</span></p>
<h1><span style="font-size: 1.17em;">安装</span></h1>
<h2><span style="font-size: 1.17em;">一、gitlab安装</span></h2>
<h3><span style="font-size: 1.17em;">1、安装gitlab yum库</span></h3>
<p><span style="color: #000000;">1.安装最新版gitlab-ee（企业版）</span></p>
<ul>
<li>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash</li>










</ul>
<p>2.安装最新版gilab-ce（社区版）</p>
<ul>
<li>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</li>










</ul>
<h3>2、安装gitlab</h3>
<p><span style="color: #ff0000;">其中ip为gitlab的访问地址。</span></p>
<p>1.企业最新版：</p>
<ul>
<li>EXTERNAL_URL="http://ip" yum install -y gitlab-ee</li>










</ul>
<p>2.社区最新版：</p>
<ul>
<li>EXTERNAL_URL="http://ip" yum install -y gitlab-ce</li>










</ul>
<p>3.安装指定版本：</p>
<ul>
<li>EXTERNAL_URL="http://ip" yum install -y gitlab-ee-12.1.9-ee.0.el7.x86_64</li>
<li>EXTERNAL_URL="http://ip" yum install -y gitlab-ce-12.1.9-ce.0.el7.x86_64</li>










</ul>
<p>4.安装完成基本指令：</p>
<p>查看运行状态</p>
<ul>
<li>gitlab-ctl status</li>










</ul>
<p>启动</p>
<ul>
<li>gitlab-ctl start</li>










</ul>
<p>停止</p>
<ul>
<li>gitlab-ctl stop</li>










</ul>
<p>重启</p>
<ul>
<li>gitlab-ctl restart</li>










</ul>
<p>查看版本</p>
<ul>
<li>cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</li>










</ul>
<p>重载配置</p>
<ul>
<li>gitlab-ctl reconfigure</li>










</ul>
<h3>3、访问gitlab</h3>
<p>http://ip 浏览器打开</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201909/1335688-20190916103216129-1634078003.png" alt="" /></p>
<p>设置root管理员初始密码。</p>
<p>设置邮箱及https等请参考原文。</p>
<h2>二、gitlab备份、恢复</h2>
<h3>1.gitlab备份</h3>
<p>1.设置gitlab备份目录、权限、有限期</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">[root@localhost /]# cat /etc/gitlab/gitlab.rb | grep -v "#"
</span><span style="color: #008080;">2</span> <span style="color: #000000;">external_url 'http://192.168.8.127'   //安装设定的访问域名
</span><span style="color: #008080;">3</span> <span style="color: #000000;">gitlab_rails['manage_backup_path'] = true
</span><span style="color: #008080;">4</span> <span style="color: #000000;">gitlab_rails['backup_path'] = "/data/gitlab/backups"    //备份路径
</span><span style="color: #008080;">5</span> <span style="color: #000000;">gitlab_rails['backup_archive_permissions'] = 0644     //备份文件权限
</span><span style="color: #008080;">6</span> gitlab_rails['backup_keep_time'] = 7776000    //备份文件有效期 30天 </pre>
</div>
<p>2.创建备份路径</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">[root@localhost /]# mkdir -vp /data/gitlab/backups
</span><span style="color: #008080;">2</span> <span style="color: #000000;">mkdir: 已创建目录 "/data"
</span><span style="color: #008080;">3</span> <span style="color: #000000;">mkdir: 已创建目录 "/data/gitlab"
</span><span style="color: #008080;">4</span> mkdir: 已创建目录 "/data/gitlab/backups"</pre>
</div>
<p>3.重载配置</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost /]# gitlab-ctl reconfigure
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">Starting Chef Client, version 14.13.11
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">resolving cookbooks for run list: ["gitlab-ee"]
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">Synchronizing Cookbooks:
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">  - gitlab-ee (0.0.1)
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">  - package (0.1.0)
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">  - gitlab (0.0.1)
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">  - consul (0.1.0)
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">  - runit (4.3.0)
</span><span style="color: #008080;">10</span> <span style="color: #000000;">  - redis (0.1.0)
</span><span style="color: #008080;">11</span> <span style="color: #000000;">  - repmgr (0.1.0)
</span><span style="color: #008080;">12</span> <span style="color: #000000;">  - postgresql (0.1.0)
</span><span style="color: #008080;">13</span> <span style="color: #000000;">  - gitaly (0.1.0)
</span><span style="color: #008080;">14</span> <span style="color: #000000;">  - letsencrypt (0.1.0)
</span><span style="color: #008080;">15</span> <span style="color: #000000;">  - monitoring (0.1.0)
</span><span style="color: #008080;">16</span> <span style="color: #000000;">  - registry (0.1.0)
</span><span style="color: #008080;">17</span> <span style="color: #000000;">  - mattermost (0.1.0)
</span><span style="color: #008080;">18</span> <span style="color: #000000;">  - nginx (0.1.0)
</span><span style="color: #008080;">19</span> <span style="color: #000000;">  - acme (4.0.0)
</span><span style="color: #008080;">20</span> <span style="color: #000000;">  - crond (0.1.0)
</span><span style="color: #008080;">21</span> <span style="color: #000000;">Installing Cookbook Gems:
</span><span style="color: #008080;">22</span> <span style="color: #000000;">Compiling Cookbooks...
</span><span style="color: #008080;">23</span> <span style="color: #000000;">Recipe: gitlab::default
</span><span style="color: #008080;">24</span> <span style="color: #000000;">&hellip;&hellip;
</span><span style="color: #008080;">25</span> <span style="color: #000000;">&hellip;&hellip;
</span><span style="color: #008080;">26</span> <span style="color: #000000;">&hellip;&hellip;
</span><span style="color: #008080;">27</span> <span style="color: #000000;">     (up to date)
</span><span style="color: #008080;">28</span> Recipe: <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Dynamically </span><span style="color: #ff0000;">Defined Resource</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">29</span> <span style="color: #000000;">  * service[repmgrd] action nothing (skipped due to action :nothing)
</span><span style="color: #008080;">30</span> <span style="color: #000000;">Recipe: repmgr::repmgrd_disable
</span><span style="color: #008080;">31</span> <span style="color: #000000;">  * runit_service[repmgrd] action disable
</span><span style="color: #008080;">32</span> <span style="color: #000000;">    * ruby_block[disable repmgrd] action run (skipped due to only_if)
</span><span style="color: #008080;">33</span> <span style="color: #000000;">     (up to date)
</span><span style="color: #008080;">34</span> <span style="color: #000000;">Recipe: gitlab-ee::geo-secondary_disable
</span><span style="color: #008080;">35</span> <span style="color: #000000;">  * templatesymlink[Removes database_geo.yml symlink] action delete
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    * file[/var/opt/gitlab/gitlab-rails/etc/database_geo.yml] action delete (up to date)
</span><span style="color: #008080;">37</span> <span style="color: #000000;">    * link[/opt/gitlab/embedded/service/gitlab-rails/config/database_geo.yml] action delete (up to date)
</span><span style="color: #008080;">38</span> <span style="color: #000000;">     (up to date)
</span><span style="color: #008080;">39</span> Recipe: <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Dynamically </span><span style="color: #ff0000;">Defined Resource</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">40</span> <span style="color: #000000;">  * service[unicorn] action restart
</span><span style="color: #008080;">41</span> <span style="color: #000000;">    - restart service service[unicorn]
</span><span style="color: #008080;">42</span> <span style="color: #000000;">  * service[sidekiq] action restart
</span><span style="color: #008080;">43</span> <span style="color: #000000;">    - restart service service[sidekiq]
</span><span style="color: #008080;">44</span> <span style="color: #000000;">Recipe: gitlab::gitlab-rails
</span><span style="color: #008080;">45</span> <span style="color: #000000;">  * execute[clear the gitlab-rails cache] action run
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    - execute /opt/gitlab/bin/gitlab-rake cache:clear
</span><span style="color: #008080;">47</span> <span style="color: #000000;">Running handlers:
</span><span style="color: #008080;">48</span> <span style="color: #000000;">Running handlers complete
</span><span style="color: #008080;">49</span> Chef Client finished, 10/708 resources updated in 29 seconds</pre>
</div>
<p>4.开始备份</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost /]# gitlab-rake gitlab:backup:create
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">2019-09-16 11:00:23 +0800 -- Dumping database ... 
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">Dumping PostgreSQL database gitlabhq_production ... [DONE]
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping repositories ...
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping uploads ... 
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping builds ... 
</span><span style="color: #008080;">10</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;">11</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping artifacts ... 
</span><span style="color: #008080;">12</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;">13</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping pages ... 
</span><span style="color: #008080;">14</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;">15</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping lfs objects ... 
</span><span style="color: #008080;">16</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- done
</span><span style="color: #008080;">17</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- Dumping container registry images ... 
</span><span style="color: #008080;">18</span> <span style="color: #000000;">2019-09-16 11:00:24 +0800 -- [DISABLED]
</span><span style="color: #008080;">19</span> <span style="color: #000000;">Creating backup archive: 1568602824_2019_09_16_12.2.5-ee_gitlab_backup.tar ... done
</span><span style="color: #008080;">20</span> <span style="color: #000000;">Uploading backup archive to remote storage  ... skipped
</span><span style="color: #008080;">21</span> <span style="color: #000000;">Deleting tmp directories ... done
</span><span style="color: #008080;">22</span> <span style="color: #000000;">done
</span><span style="color: #008080;">23</span> <span style="color: #000000;">done
</span><span style="color: #008080;">24</span> <span style="color: #000000;">done
</span><span style="color: #008080;">25</span> <span style="color: #000000;">done
</span><span style="color: #008080;">26</span> <span style="color: #000000;">done
</span><span style="color: #008080;">27</span> <span style="color: #000000;">done
</span><span style="color: #008080;">28</span> <span style="color: #000000;">done
</span><span style="color: #008080;">29</span> <span style="color: #000000;">Deleting old backups ... done. (0 removed)
</span><span style="color: #ff0000;">30 Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data 
31 and are not included in this backup. You will need these files to restore a backup.
32 Please back them up manually.
</span><span style="color: #008080;">33</span> Backup task is done.</pre>
</div>
<p>红字部分表示&nbsp;gitlab.rb 和 gitlab-secrets.json 两个文件包含敏感信息。未被备份到备份文件中。需要手动备份。</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">[root@localhost backups]# pwd
</span><span style="color: #008080;">2</span> <span style="color: #000000;">/data/gitlab/backups
</span><span style="color: #008080;">3</span> <span style="color: #000000;">[root@localhost backups]# ls -l
</span><span style="color: #008080;">4</span> <span style="color: #000000;">总用量 132
</span><span style="color: #008080;">5</span> <span style="color: #000000;">-rw-r--r-- 1 git git 133120 9月  16 11:00 1568602824_2019_09_16_12.2.5-ee_gitlab_backup.tar
</span><span style="color: #008080;">6</span> [root@localhost backups]# </pre>
</div>
<p>执行完成后在&nbsp;/data/gitlab/backups 中生成了备份文件。</p>
<h3>2.gitlab恢复备份</h3>
<p>1.首先停用gitlab的数据连接部分服务</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop unicorn
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">ok: down: unicorn: 0s, normally up
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop sidekiq
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">ok: down: sidekiq: 0s, normally up
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop nginx
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">ok: down: nginx: 0s, normally up
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl status
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">run: alertmanager: (pid 30960) 3683s; run: log: (pid 30623) 3735s
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">run: gitaly: (pid 30846) 3685s; run: log: (pid 30081) 3828s
</span><span style="color: #008080;">10</span> <span style="color: #000000;">run: gitlab-monitor: (pid 30843) 3685s; run: log: (pid 30498) 3753s
</span><span style="color: #008080;">11</span> <span style="color: #000000;">run: gitlab-workhorse: (pid 30820) 3686s; run: log: (pid 30349) 3784s
</span><span style="color: #008080;">12</span> <span style="color: #000000;">run: grafana: (pid 30980) 3682s; run: log: (pid 30750) 3698s
</span><span style="color: #008080;">13</span> <span style="color: #000000;">run: logrotate: (pid 37253) 178s; run: log: (pid 30384) 3777s
</span><span style="color: #008080;">14</span> <span style="color: #000000;">down: nginx: 4s, normally up; run: log: (pid 30368) 3781s
</span><span style="color: #008080;">15</span> <span style="color: #000000;">run: node-exporter: (pid 30830) 3685s; run: log: (pid 30418) 3764s
</span><span style="color: #008080;">16</span> <span style="color: #000000;">run: postgres-exporter: (pid 30971) 3683s; run: log: (pid 30650) 3730s
</span><span style="color: #008080;">17</span> <span style="color: #000000;">run: postgresql: (pid 30127) 3825s; run: log: (pid 30139) 3821s
</span><span style="color: #008080;">18</span> <span style="color: #000000;">run: prometheus: (pid 30943) 3684s; run: log: (pid 30588) 3741s
</span><span style="color: #008080;">19</span> <span style="color: #000000;">run: redis: (pid 29960) 3838s; run: log: (pid 29972) 3835s
</span><span style="color: #008080;">20</span> <span style="color: #000000;">run: redis-exporter: (pid 30854) 3684s; run: log: (pid 30522) 3747s
</span><span style="color: #008080;">21</span> <span style="color: #000000;">down: sidekiq: 13s, normally up; run: log: (pid 30324) 3788s
</span><span style="color: #008080;">22</span> down: unicorn: 17s, normally up; run: log: (pid 30307) 3792s</pre>
</div>
<p>2.执行恢复</p>
<p>远程复制的备份需要&nbsp; chmod 777&nbsp;1568602824_2019_09_16_12.2.5-ee.....&nbsp; &nbsp;赋予权限</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost backups]# gitlab-rake gitlab:backup:restore BACKUP=1568602824_2019_09_16_12.2.5-ee
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">Unpacking backup ... done
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">Before restoring the database, we will remove all existing
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">tables to avoid future upgrade problems. Be aware that if you have
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">custom tables in the GitLab database these tables and all data will be
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">removed.
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">Do you want to continue (yes/no)? yes
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">This task will now rebuild the authorized_keys file.
</span><span style="color: #008080;">10</span> <span style="color: #000000;">You will lose any data stored in the authorized_keys file.
</span><span style="color: #008080;">11</span> <span style="color: #000000;">Do you want to continue (yes/no)? yes
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span> <span style="color: #000000;">Deleting tmp directories ... done
</span><span style="color: #008080;">14</span> <span style="color: #000000;">done
</span><span style="color: #008080;">15</span> <span style="color: #000000;">done
</span><span style="color: #008080;">16</span> <span style="color: #000000;">done
</span><span style="color: #008080;">17</span> <span style="color: #000000;">done
</span><span style="color: #008080;">18</span> <span style="color: #000000;">done
</span><span style="color: #008080;">19</span> <span style="color: #000000;">done
</span><span style="color: #008080;">20</span> <span style="color: #000000;">done
</span><span style="color: #ff0000;">21 Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data 
22 and are not included in this backup. You will need to restore these files manually.
</span><span style="color: #008080;">23</span> Restore task is done.</pre>
</div>
<p><span style="color: #ff0000;">备份tar包一定要放到备份路径下。恢复是删除原有数据，恢复备份tar包中的数据。</span></p>
<p><span style="color: #ff0000;">如果是在其他服务器恢复备份，一定要记得将&nbsp;gitlab.rb 和 gitlab-secrets.json 手动复制到相应路径下。</span></p>
<p><span style="color: #ff0000;">gitlab.rb路径：/etc/gitlab/gitlab.rb</span></p>
<p><span style="color: #ff0000;">gitlab-secrets.json路径：/etc/gitlab/gitlab-secrets.json</span></p>
<p><span style="color: #000000;">3.重载配置&nbsp;</span></p>
<ul>
<li>gitlab-ctl reconfigure</li>
</ul>
<p>4.重启gitlab，check检查</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl restart
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">ok: run: alertmanager: (pid 30960) 3785s
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">ok: run: gitaly: (pid 30846) 3787s
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">ok: run: gitlab-monitor: (pid 30843) 3787s
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">ok: run: gitlab-workhorse: (pid 30820) 3788s
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">ok: run: grafana: (pid 30980) 3784s
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">ok: run: logrotate: (pid 37253) 280s
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">ok: run: nginx: (pid 37535) 0s
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">ok: run: node-exporter: (pid 30830) 3787s
</span><span style="color: #008080;">10</span> <span style="color: #000000;">ok: run: postgres-exporter: (pid 30971) 3785s
</span><span style="color: #008080;">11</span> <span style="color: #000000;">ok: run: postgresql: (pid 30127) 3927s
</span><span style="color: #008080;">12</span> <span style="color: #000000;">ok: run: prometheus: (pid 30943) 3786s
</span><span style="color: #008080;">13</span> <span style="color: #000000;">ok: run: redis: (pid 29960) 3940s
</span><span style="color: #008080;">14</span> <span style="color: #000000;">ok: run: redis-exporter: (pid 30854) 3786s
</span><span style="color: #008080;">15</span> <span style="color: #000000;">ok: run: sidekiq: (pid 37547) 1s
</span><span style="color: #008080;">16</span> <span style="color: #000000;">ok: run: unicorn: (pid 37553) 0s
</span><span style="color: #008080;">17</span> <span style="color: #000000;">[root@localhost backups]# gitlab-rake gitlab:check SANITIZE=true
</span><span style="color: #008080;">18</span> <span style="color: #000000;">Checking GitLab subtasks ...
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span> <span style="color: #000000;">Checking GitLab Shell ...
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span> <span style="color: #000000;">GitLab Shell: ... GitLab Shell version &gt;= 9.3.0 ? ... OK (9.3.0)
</span><span style="color: #008080;">23</span> <span style="color: #000000;">Running /opt/gitlab/embedded/service/gitlab-shell/bin/check
</span><span style="color: #008080;">24</span> <span style="color: #000000;">Check GitLab API access: OK
</span><span style="color: #008080;">25</span> <span style="color: #000000;">Redis available via internal API: OK
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span> <span style="color: #000000;">Access to /var/opt/gitlab/.ssh/authorized_keys: OK
</span><span style="color: #008080;">28</span> <span style="color: #000000;">gitlab-shell self-check successful
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span> <span style="color: #000000;">Checking GitLab Shell ... Finished
</span><span style="color: #008080;">31</span> 
<span style="color: #008080;">32</span> <span style="color: #000000;">Checking Gitaly ...
</span><span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span> <span style="color: #000000;">Gitaly: ... default ... OK
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span> <span style="color: #000000;">Checking Gitaly ... Finished
</span><span style="color: #008080;">37</span> 
<span style="color: #008080;">38</span> <span style="color: #000000;">Checking Sidekiq ...
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> <span style="color: #000000;">Sidekiq: ... Running? ... yes
</span><span style="color: #008080;">41</span> <span style="color: #000000;">Number of Sidekiq processes ... 1
</span><span style="color: #008080;">42</span> 
<span style="color: #008080;">43</span> <span style="color: #000000;">Checking Sidekiq ... Finished
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span> <span style="color: #000000;">Checking Incoming Email ...
</span><span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span> <span style="color: #000000;">Incoming Email: ... Reply by email is disabled in config/gitlab.yml
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span> <span style="color: #000000;">Checking Incoming Email ... Finished
</span><span style="color: #008080;">50</span> 
<span style="color: #008080;">51</span> <span style="color: #000000;">Checking LDAP ...
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span> <span style="color: #000000;">LDAP: ... LDAP is disabled in config/gitlab.yml
</span><span style="color: #008080;">54</span> 
<span style="color: #008080;">55</span> <span style="color: #000000;">Checking LDAP ... Finished
</span><span style="color: #008080;">56</span> 
<span style="color: #008080;">57</span> <span style="color: #000000;">Checking GitLab App ...
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span> <span style="color: #000000;">Git configured correctly? ... yes
</span><span style="color: #008080;">60</span> <span style="color: #000000;">Database config exists? ... yes
</span><span style="color: #008080;">61</span> <span style="color: #000000;">All migrations up? ... yes
</span><span style="color: #008080;">62</span> <span style="color: #000000;">Database contains orphaned GroupMembers? ... no
</span><span style="color: #008080;">63</span> <span style="color: #000000;">GitLab config exists? ... yes
</span><span style="color: #008080;">64</span> <span style="color: #000000;">GitLab config up to date? ... yes
</span><span style="color: #008080;">65</span> <span style="color: #000000;">Log directory writable? ... yes
</span><span style="color: #008080;">66</span> <span style="color: #000000;">Tmp directory writable? ... yes
</span><span style="color: #008080;">67</span> <span style="color: #000000;">Uploads directory exists? ... yes
</span><span style="color: #008080;">68</span> <span style="color: #000000;">Uploads directory has correct permissions? ... yes
</span><span style="color: #008080;">69</span> <span style="color: #000000;">Uploads directory tmp has correct permissions? ... skipped (no tmp uploads folder yet)
</span><span style="color: #008080;">70</span> <span style="color: #000000;">Init script exists? ... skipped (omnibus-gitlab has no init script)
</span><span style="color: #008080;">71</span> <span style="color: #000000;">Init script up-to-date? ... skipped (omnibus-gitlab has no init script)
</span><span style="color: #008080;">72</span> <span style="color: #000000;">Projects have namespace: ... can't check, you have no projects
</span><span style="color: #008080;">73</span> <span style="color: #000000;">Redis version &gt;= 2.8.0? ... yes
</span><span style="color: #008080;">74</span> <span style="color: #000000;">Ruby version &gt;= 2.5.3 ? ... yes (2.6.3)
</span><span style="color: #008080;">75</span> <span style="color: #000000;">Git version &gt;= 2.22.0 ? ... yes (2.22.0)
</span><span style="color: #008080;">76</span> <span style="color: #000000;">Git user has default SSH configuration? ... yes
</span><span style="color: #008080;">77</span> <span style="color: #000000;">Active users: ... 1
</span><span style="color: #008080;">78</span> <span style="color: #000000;">Elasticsearch version 5.6 - 6.x? ... skipped (elasticsearch is disabled)
</span><span style="color: #008080;">79</span> 
<span style="color: #008080;">80</span> <span style="color: #000000;">Checking GitLab App ... Finished
</span><span style="color: #008080;">81</span> 
<span style="color: #008080;">82</span> 
<span style="color: #008080;">83</span> Checking GitLab subtasks ... Finished</pre>
</div>
<p>ok，至此恢复完成</p>
<h2>三、gitlab版本升级</h2>
<p>1.停止数据传输服务</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop unicorn
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">ok: down: unicorn: 0s, normally up
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop sidekiq
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">ok: down: sidekiq: 0s, normally up
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl stop nginx
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">ok: down: nginx: 1s, normally up
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">[root@localhost backups]# gitlab-ctl status
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">run: gitaly: (pid 73164) 939s; run: log: (pid 72843) 968s
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">run: gitlab-monitor: (pid 73232) 938s; run: log: (pid 73021) 957s
</span><span style="color: #008080;">10</span> <span style="color: #000000;">run: gitlab-workhorse: (pid 75742) 136s; run: log: (pid 72919) 962s
</span><span style="color: #008080;">11</span> <span style="color: #000000;">run: logrotate: (pid 72985) 960s; run: log: (pid 72984) 960s
</span><span style="color: #008080;">12</span> <span style="color: #000000;">down: nginx: 5s, normally up; run: log: (pid 72960) 961s
</span><span style="color: #008080;">13</span> <span style="color: #000000;">run: node-exporter: (pid 73003) 959s; run: log: (pid 73002) 959s
</span><span style="color: #008080;">14</span> <span style="color: #000000;">run: postgres-exporter: (pid 73253) 937s; run: log: (pid 73086) 948s
</span><span style="color: #008080;">15</span> <span style="color: #000000;">run: postgresql: (pid 72644) 997s; run: log: (pid 72643) 997s
</span><span style="color: #008080;">16</span> <span style="color: #000000;">run: prometheus: (pid 73241) 938s; run: log: (pid 73064) 950s
</span><span style="color: #008080;">17</span> <span style="color: #000000;">run: redis: (pid 72598) 1003s; run: log: (pid 72597) 1003s
</span><span style="color: #008080;">18</span> <span style="color: #000000;">run: redis-exporter: (pid 73048) 951s; run: log: (pid 73047) 951s
</span><span style="color: #008080;">19</span> <span style="color: #000000;">down: sidekiq: 7s, normally up; run: log: (pid 72818) 974s
</span><span style="color: #008080;">20</span> down: unicorn: 10s, normally up; run: log: (pid 72778) 976s</pre>
</div>
<p>2.下载最新的ce/ee rpm包（清华源https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/yum/el7/ 或者https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/）</p>
<ul>
<li>wget&nbsp;https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/yum/el7/gitlab-ee-12.2.5-ee.0.el7.x86_64.rpm</li>
</ul>
<p>gitlab10.0.0版本升级最新版本需要先升级到11.11.0，再升级12.2.5！</p>
<p><img src="https://img2018.cnblogs.com/blog/1335688/201909/1335688-20190916161913442-1586926220.png" alt="" /></p>
<p>3.升级ce/ee</p>
<ul>
<li>rpm -Uvh&nbsp;gitlab-ee-12.2.5-ee.0.el7.x86_64.rpm</li>
</ul>
<p>4.重载配置</p>
<ul>
<li>gitlab-ctl reconfigure</li>
</ul>
<p>5.重启gitlab</p>
<ul>
<li>gitlab-ctl restart</li>
</ul>
<h2>四、gitlab解决内存消耗问题</h2>
<div class="cnblogs_code">
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[root@storage100 backups]# cat /etc/gitlab/gitlab.rb | grep -v "#"
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">#进程超时时间
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">unicorn['worker_timeout'] = 60
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">#进程数
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">unicorn['worker_processes'] = 10
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">#进程最小内存
</span><span style="color: #008080;"> 7</span> unicorn['worker_memory_limit_min'] = "200 * 1 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">&lt; 20</span><span style="color: #ff0000;">"
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">#进程最大内存
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">unicorn['worker_memory_limit_max'] </span><span style="color: #0000ff;">= "300 * 1 &lt;&lt; 20"</span>
<span style="color: #008080;">10</span> <span style="color: #000000;">#并发数
</span><span style="color: #008080;">11</span> <span style="color: #000000;">sidekiq['concurrency'] </span><span style="color: #0000ff;">= 16
</span><span style="color: #008080;">12</span> <span style="color: #000000;">#数据库缓存
</span><span style="color: #008080;">13</span> <span style="color: #000000;">postgresql['shared_buffers'] </span><span style="color: #0000ff;">= "256MB"</span>
<span style="color: #008080;">14</span> <span style="color: #000000;">#数据库并发数
</span><span style="color: #008080;">15</span> <span style="color: #000000;">postgresql['max_worker_processes'] </span><span style="color: #0000ff;">= 8</span></pre>
</div>
<p><span style="color: #ff0000;">参考CSDN博主"欧阳鹏",原文链接：https://blog.csdn.net/ouyang_peng/article/details/84066417</span></p>
</div>
<p>&nbsp;</p>
<p>附gitlab备份脚本：</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">#!/bin/bash

#Gitlab 备份地址
LocalBackDir=/home/gitlab/data/backups

#服务机gitlab配置文件地址
#正式环境地址：
ConfigDir=/etc/gitlab/gitlab.rb

#nginx配置文件地址
#正式环境地址：NginxDir=/home/dgd/gitlab/data/nginx/conf

#邮件配置地址
#MailDir=/etc/postfix/main.cf

#Backup server 存储路径
RemoteBackDir=/home/gitlab/data/backups

#远程备份使用用户及端口
RemoteUser=root
RemotePort=22

#备份服务器IP
RemoteIP=192.168.8.200

#以当前时间戳创建备份目录
bakname=$(date -d "today" +"%Y%m%d_%H%M%S")
BakDir=$LocalBackDir/$bakname
mkdir $BakDir

#备份日志文件
LogFile=$LocalBackDir/remote_backup.log

#新建备份日志文件
touch $LogFile

#记录配置文件备份日志
echo "Gitlab configure file auto backup at local server, start at  $(date +"%Y-%m-%d %H:%M:%S")" &gt;&gt;  $LogFile
echo "--------------------------------------------------------------------------" &gt;&gt; $LogFile

#拷贝配置文件
cp $ConfigDir $BakDir &gt;&gt; $LogFile 2&gt;</span><span style="color: #ff0000;">&amp;1</span><span style="color: #000000;">
#cp -r $NginxDir $BakDir &gt;&gt; $LogFile 2&gt;</span><span style="color: #ff0000;">&amp;1</span><span style="color: #000000;">
#cp $MailDir $BakDir &gt;&gt; $LogFile 2&gt;</span><span style="color: #ff0000;">&amp;1</span><span style="color: #000000;">

#记录本地生成gitlab备份日志
echo "Gitlab auto backup at local server, start at  $(date +"%Y-%m-%d %H:%M:%S")" &gt;&gt;  $LogFile
echo "--------------------------------------------------------------------------" &gt;&gt; $LogFile

#执行gitlab本地备份
gitlab-rake gitlab:backup:create &gt;&gt; $LogFile 2&gt;</span><span style="color: #ff0000;">&amp;1</span><span style="color: #000000;">

# $?符号显示上一条命令的返回值，如果为0则代表执行成功，其他表示失败
if [ $? -eq 0 ];then
   #追加日志到日志文件
   echo "--------------------------------Success!-------------------------------" &gt;&gt; $LogFile
   echo "Gitlab auto backup at local server, end at $(date +"%Y-%m-%d %H:%M:%S")" &gt;&gt; $LogFile
else
   #追加日志到日志文件
   echo "--------------------------------Failed!----------------------------------" &gt;&gt; $LogFile
   echo "Gitlab auto backup at local server failed at $(date +"%Y-%m-%d %H:%M:%S")" &gt;&gt; $LogFile
fi


#查找本地备份目录修改时间为10分钟以内且后缀为.tar的Gitlab备份文件
Backfile_Send_To_Remote=`find $LocalBackDir -type f  -mmin -10 -name '*.tar'` &gt;&gt; $LogFile 2&gt;</span><span style="color: #ff0000;">&amp;1</span><span style="color: #000000;">

#移动生成的备份文件到配置文件备份地址
mv -bfu $Backfile_Send_To_Remote $BakDir 


#记录备份日志
echo "$(date +"%Y-%m-%d %H:%M:%S") Gitlab auto backup to remote server." &gt;&gt; $LogFile
echo "--------------------------------------------" &gt;&gt; $LogFile

#打印每次备份的档案名
echo "The files need send to remote server is: $Backfile_Send_To_Remote" &gt;&gt; $LogFile

# 本地传输Gitlab备份档案到远程
scp -r  $BakDir $RemoteUser@$RemoteIP:$RemoteBackDir

# 备份结果追加到备份日志
if [ $? -eq 0 ];then
  echo ""
  echo "$(date +"%Y-%m-%d %H:%M:%S") Gitlab Remote Backup Succeed!" &gt;&gt; $LogFile
else
  echo "$(date +"%Y-%m-%d %H:%M:%S") Gitlab Remote Backup Failed!" &gt;&gt; $LogFile
fi</span></pre>
</div>
<p>&nbsp;</p>